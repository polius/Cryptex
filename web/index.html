<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cryptex - Lock down your data. Send it securely.</title>
  <meta name="description" content="Share text and files with optional password protection and expiring links." />
  <meta name="robots" content="index, follow" />
  <link rel="icon" type="image/svg+xml" href="assets/logo.svg">
  <script>
    // Load theme immediately to prevent flash (must be before stylesheets)
    (function() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-bs-theme', savedTheme);
      document.documentElement.setAttribute('data-theme', savedTheme);
      requestAnimationFrame(function() { document.documentElement.classList.add('theme-ready'); });
    })();
  </script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="css/style.css" />
</head>
<body class="d-flex align-items-center justify-content-center px-1 py-4">
  <!-- Full-page overlay (shown until mode is determined) -->
  <div id="initialLoader" class="initial-loader"><div class="initial-spinner"></div></div>

  <div id="pageContent" style="display: none; width: 100%;">
  <div class="top-nav-buttons">
    <a href="/monitor" id="adminToggle" class="admin-toggle" aria-label="Admin panel" title="Admin panel">
      <i class="bi bi-gear-fill"></i><span class="d-none d-md-inline ms-2">Admin</span>
    </a>
    <button id="apiReferenceToggle" class="api-toggle" aria-label="API Reference" title="API Reference">
      <i class="bi bi-code-slash"></i><span class="d-none d-md-inline ms-2">API</span>
    </button>
    <button id="themeToggle" class="theme-toggle" aria-label="Dark mode" title="Dark mode">
      <i class="bi bi-moon-fill" id="themeIcon"></i><span class="d-none d-md-inline ms-2">Dark</span>
    </button>
    <a href="/login" id="loginToggle" class="login-toggle" aria-label="Login" title="Admin Login">
      <i class="bi bi-box-arrow-in-right"></i><span class="d-none d-md-inline ms-2">Login</span>
    </a>
    <a href="#" id="logoutToggle" class="logout-toggle" aria-label="Logout" title="Logout">
      <i class="bi bi-box-arrow-right"></i><span class="d-none d-md-inline ms-2">Logout</span>
    </a>
  </div>
  
  <div class="container">
    <header class="app-header">
      <div class="header-brand-wrapper">
        <a href="/" class="header-brand">
          <div class="header-icon">
            <img src="assets/logo.svg" alt="Cryptex" />
          </div>
          <h1 class="app-title">Cryptex<span class="app-version" id="appVersion"></span></h1>
        </a>
      </div>
      <p class="app-subtitle">Lock down your data. Send it securely.</p>
    </header>

    <div class="row justify-content-center">
      <div class="col-lg-8">
        <!-- Status Banner (private mode, link errors, etc.) -->
        <div id="linkBanner" class="status-page" style="display: none;"></div>
        
        <div class="card" id="mainCard" style="display: none;">
          <!-- Step 1: Create -->
          <div id="step1">
            <div class="card-header">
              <h3>Create Cryptex</h3>
            </div>
            <div class="card-body">
              <div>
                <label for="encMessage" class="form-label">Text</label>
                <textarea id="encMessage" class="form-control" rows="4" placeholder="Enter your text (optional)" aria-label="Cryptex text"></textarea>
                <div id="encMessageCount" class="char-count">0 / 1000</div>
              </div>
              <div>
                <label for="encFiles" class="form-label">Files <span class="text-muted" id="encFilesLimit">(max 5 files)</span></label>
                <input type="file" id="encFiles" class="form-control" multiple accept="*/*" aria-label="File attachments" />
                <div id="encFilesInfo" class="char-count" style="display: none;">0 / 5 files</div>
                <div id="encFilesList" class="file-list" style="margin-top: 10px;"></div>
              </div>
              
              <div class="password-section">
                <label for="encPwd" class="form-label">Password <span class="text-muted">(optional)</span></label>
                <div class="input-group">
                  <input type="password" id="encPwd" class="form-control" placeholder="Leave empty for no password" autocomplete="new-password" aria-label="Cryptex password" maxlength="100" />
                  <button class="btn btn-icon" type="button" id="generatePwdBtn" title="Generate password" aria-label="Generate random password">
                    <i class="bi bi-magic"></i>
                  </button>
                  <button class="btn btn-icon" type="button" id="encPwdToggle" title="Toggle visibility" aria-label="Toggle password visibility">
                    <i class="bi bi-eye-fill" id="encPwdToggleIcon"></i>
                  </button>
                </div>
              </div>
              
              <!-- Advanced Options Toggle -->
              <div class="advanced-options-wrapper">
                <button type="button" class="advanced-options-toggle" id="advancedToggle" aria-expanded="false" aria-controls="advancedOptions">
                  <i class="bi bi-chevron-right"></i>
                  <span>Advanced options</span>
                </button>
                <div class="advanced-options-content" id="advancedOptions">
                  <div class="settings-row">
                    <div class="settings-item">
                      <label for="encExpiration" class="form-label">Expiration</label>
                      <div class="input-group">
                        <input type="number" id="encExpirationValue" class="form-control" value="1" min="1" max="30" aria-label="Expiration value" />
                        <select id="encExpirationUnit" class="form-select" aria-label="Expiration unit">
                          <option value="minutes">Minutes</option>
                          <option value="hours">Hours</option>
                          <option value="days" selected>Days</option>
                        </select>
                      </div>
                    </div>
                    <div class="settings-item settings-item-auto">
                      <label class="form-label">&nbsp;</label>
                      <div class="autodestroy-toggle" data-tooltip="Cryptex will be permanently destroyed when you leave the page after opening it">
                        <input class="form-check-input" type="checkbox" id="autodestroy">
                        <label class="form-check-label" for="autodestroy">Self-destruct</label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <button id="encBtn" class="btn btn-primary" aria-label="Create cryptex">
                Create Cryptex
              </button>
              <div id="encStatus" class="status-section" style="display: none">
                <div id="encProgress" class="upload-progress" style="display: none">
                  <div class="progress-header">
                    <div class="progress-info">
                      <div id="encProgressText" class="progress-text">Processing...</div>
                      <div id="encProgressSubtext" class="progress-subtext"></div>
                    </div>
                    <button id="encCancelBtn" class="btn-cancel" aria-label="Cancel upload" title="Cancel upload">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                  <div class="progress-bar-container">
                    <div class="progress">
                      <div id="encProgressBar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <span id="encProgressPercent" class="progress-percent">0%</span>
                  </div>
                  <div id="encProgressDetails" class="progress-details">
                    <span id="encProgressSize"></span>
                    <span id="encProgressFile"></span>
                  </div>
                </div>
                <div id="encLog" class="status-log" style="display: none">
                  <i class="success-icon bi bi-check-circle-fill" style="display: none"></i>
                  <span class="status-message"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2: Open -->
          <div id="step2">
            <div class="card-header open">
              <i class="bi bi-shield-check"></i>
              <h3>Open Cryptex</h3>
            </div>
            <div class="card-body">
              <div>
                <label for="decId" class="form-label">Cryptex ID</label>
                <input type="text" class="form-control" id="decId" placeholder="Enter cryptex ID" aria-label="Cryptex ID" readonly required />
              </div>
              <div id="decPwdGroup" style="display: none">
                <label for="decPwd" class="form-label">Password</label>
                <div class="input-group">
                  <input type="password" id="decPwd" class="form-control" placeholder="Enter password" autocomplete="new-password" aria-label="Cryptex password" maxlength="100" />
                  <button class="btn btn-icon" type="button" id="decPwdToggle" title="Toggle visibility" aria-label="Toggle password visibility">
                    <i class="bi bi-eye-fill" id="decPwdToggleIcon"></i>
                  </button>
                </div>
              </div>
              <button id="decBtn" class="btn btn-success" aria-label="Open cryptex">
                Open Cryptex
              </button>
              <div id="decStatus" class="status-section" style="display: none">
                <div id="decProgress" class="upload-progress" style="display: none">
                  <div class="progress-header">
                    <div class="progress-info">
                      <div id="decProgressText" class="progress-text">Opening...</div>
                      <div id="decProgressSubtext" class="progress-subtext"></div>
                    </div>
                  </div>
                  <div class="progress-bar-container">
                    <div class="progress">
                      <div id="decProgressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <span id="decProgressPercent" class="progress-percent">0%</span>
                  </div>
                  <div id="decProgressDetails" class="progress-details">
                    <span id="decProgressFile"></span>
                  </div>
                </div>
                <div id="decLog" class="status-log" style="display: none">
                  <i class="success-icon bi bi-check-circle-fill" style="display: none"></i>
                  <span class="status-message"></span>
                </div>
              </div>
              <div id="decFilesList" class="file-list" style="margin-top: 20px; display: none;"></div>
            </div>
          </div>

          <!-- Step 3: Success -->
          <div id="step3">
            <div class="card-header success">
              <i class="bi bi-check-circle-fill"></i>
              <h3>Cryptex Created</h3>
            </div>
            <div class="card-body">
              <div class="success-message" id="successMessage" style="display: none;">
                <p>Your cryptex has been created successfully.</p>
              </div>
              <div id="qrPreview" class="qr-preview" style="display: none;">
                <label class="form-label">Cryptex QR</label>
                <div class="qr-preview-container">
                  <div class="qr-preview-image"></div>
                  <span class="qr-preview-hint">Click to enlarge</span>
                </div>
              </div>
              <div id="cryptexUrlSection">
                <label for="cryptexUrl" class="form-label">Cryptex URL</label>
                <div class="input-group">
                  <input type="text" id="cryptexUrl" class="form-control" readonly aria-label="Cryptex URL" />
                  <button class="btn btn-icon" type="button" id="copyUrlBtn" title="Copy to clipboard" aria-label="Copy URL to clipboard">
                    <i class="bi bi-clipboard" id="copyUrlIcon"></i>
                  </button>
                </div>
                <div class="url-info-row">
                  <div id="passwordSection">
                    <div class="password-url-option" data-tooltip="Enables one-click access. Password stays in browser, never sent to server.">
                      <input class="form-check-input" type="checkbox" id="includePasswordInUrl">
                      <label class="form-check-label" for="includePasswordInUrl">
                        Include password in URL
                      </label>
                    </div>
                  </div>
                  <div id="cryptexUrlExpiration" class="char-count"></div>
                </div>
              </div>
              <div id="passwordField" class="password-field">
                <label for="cryptexPassword" class="form-label">Password</label>
                <div class="input-group">
                  <input type="password" id="cryptexPassword" class="form-control" readonly aria-label="Cryptex password" />
                  <button class="btn btn-icon" type="button" id="cryptexPwdToggle" title="Toggle visibility" aria-label="Toggle password visibility">
                    <i class="bi bi-eye-fill" id="cryptexPwdToggleIcon"></i>
                  </button>
                  <button class="btn btn-icon" type="button" id="copyPwdBtn" title="Copy to clipboard" aria-label="Copy password to clipboard">
                    <i class="bi bi-clipboard" id="copyPwdIcon"></i>
                  </button>
                </div>
              </div>
              <div class="button-group mt-4">
                <button id="openCryptexBtn" class="btn btn-success" aria-label="Open Cryptex">
                  Open Cryptex
                </button>
              </div>
            </div>
          </div>

          <!-- Step 4: Opened Content -->
          <div id="step4">
            <div class="card-header success">
              <i class="bi bi-check-circle-fill"></i>
              <h3>Cryptex Opened</h3>
            </div>
            <div class="card-body">
              <div id="autoDestroyBanner" class="autodestroy-banner" style="display: none;">
                <i class="bi bi-fire"></i>
                <div>
                  <strong>Self-destruct enabled</strong>
                  <p>This cryptex is one-time use. Each file can only be downloaded once.</p>
                </div>
              </div>
              <div>
                <label class="form-label">Text</label>
                <div class="input-group">
                  <div id="openedMessage" class="opened-content flex-grow-1"></div>
                  <button class="btn btn-icon" type="button" id="copyMessageBtn" title="Copy message to clipboard" aria-label="Copy message to clipboard">
                    <i class="bi bi-clipboard" id="copyMessageIcon"></i>
                  </button>
                </div>
              </div>
              <div id="openedFilesList" class="file-list" style="display: none;">
                <label class="form-label">Files</label>
              </div>
              <button id="downloadAllBtn" class="btn btn-secondary mt-2" style="display: none;" aria-label="Download all files">
                <i class="bi bi-download"></i> Download All
              </button>
              <div class="opened-meta">
                <div id="openedExpiration" class="char-count"></div>
                <div id="openedViews" class="char-count"></div>
              </div>
              <div class="button-group mt-4">
                <button id="destroyBtn" class="btn btn-danger" aria-label="Destroy cryptex">
                  Destroy Cryptex
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast-container" class="toast-container position-fixed top-0 start-50 translate-middle-x p-3"></div>

  <!-- Custom Dialog -->
  <div id="customDialog" class="custom-dialog" style="display: none;">
    <div class="custom-dialog-backdrop"></div>
    <div class="custom-dialog-content">
      <div class="custom-dialog-header">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <h3 id="dialogTitle">Confirm Action</h3>
      </div>
      <div class="custom-dialog-body">
        <p id="dialogMessage"></p>
      </div>
      <div class="custom-dialog-footer">
        <button id="dialogCancelBtn" class="btn btn-secondary">Cancel</button>
        <button id="dialogConfirmBtn" class="btn btn-danger">Confirm</button>
      </div>
    </div>
  </div>

  </div>

  <!-- QR Expanded Dialog -->
  <div id="qrDialog" class="qr-dialog" style="display: none;">
    <div class="qr-dialog-backdrop"></div>
    <div class="qr-dialog-content">
      <div id="qrDialogBody" class="qr-dialog-body"></div>
      <button id="qrDialogCloseBtn" class="btn btn-secondary">Close</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
  <script src="js/common.js"></script>
  <script src="js/script.js" type="text/javascript"></script>
  <script src="js/api-reference.js"></script>
</body>
</html>
